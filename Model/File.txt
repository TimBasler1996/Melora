//
//  AppUser+Firestore.swift
//  SocialSound
//

import Foundation
import FirebaseFirestore

extension AppUser {

    /// Maps a Firestore `users/{uid}` document into an `AppUser`.
    ///
    /// Firestore uses the Firebase Auth UID as document id.
    /// This mapper is lenient (missing fields become nil) so the app
    /// keeps working while the schema evolves.
    static func fromFirestore(docId: String, data: [String: Any]) -> AppUser {

        // Helpers
        func string(_ key: String) -> String? {
            data[key] as? String
        }

        func int(_ key: String) -> Int? {
            if let v = data[key] as? Int { return v }
            if let v = data[key] as? Int64 { return Int(v) }
            if let v = data[key] as? Double { return Int(v) }
            return nil
        }

        func bool(_ key: String) -> Bool? {
            data[key] as? Bool
        }

        func date(_ key: String) -> Date? {
            if let ts = data[key] as? Timestamp { return ts.dateValue() }
            if let d = data[key] as? Date { return d }
            return nil
        }

        func stringArray(_ key: String) -> [String]? {
            data[key] as? [String]
        }

        // Nested location
        var lastLocation: LocationPoint? = nil
        if let loc = data["lastLocation"] as? [String: Any],
           let lat = loc["latitude"] as? Double,
           let lon = loc["longitude"] as? Double {
            lastLocation = LocationPoint(latitude: lat, longitude: lon)
        }

        // Avatar source
        var avatarSource: AppUser.AvatarSource? = nil
        if let raw = string("avatarSource") {
            avatarSource = AppUser.AvatarSource(rawValue: raw)
        }

        return AppUser(
            id: docId,
            spotifyId: string("spotifyId"),
            displayName: string("displayName") ?? "Unknown",
            age: int("age"),
            hometown: string("hometown"),
            musicTaste: string("musicTaste"),
            photoURLs: stringArray("photoURLs"),
            avatarURL: string("avatarURL"),
            avatarSource: avatarSource,
            isBroadcasting: bool("isBroadcasting"),
            lastLocation: lastLocation,
            lastActiveAt: date("lastActiveAt"),
            profileCompleted: bool("profileCompleted"),
            createdAt: date("createdAt"),
            updatedAt: date("updatedAt")
        )
    }
}
